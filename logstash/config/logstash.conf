filter {
  # journalctl adds stuff to every log entry in dcos. Parse this and remove it.
#  grok {
#    match => {
#      "message" => "^([A-Za-z]+ [0-9]+ [0-9:]+) %{HOSTNAME:host} (?<processName>[^\[]+)\[%{POSINT:pid}\]: *%{GREEDYDATA:message}"
#    }
#    overwrite => [ "message", "host" ]
#  }
  # match Marathon logback format
  grok {
    match => {
      "message" => "^(\[%{TIMESTAMP_ISO8601:logdate}\] %{LOGLEVEL:logLevel} *%{GREEDYDATA:message}|%{TIMESTAMP_ISO8601:logdate}: *%{GREEDYDATA:message})"
    }
    overwrite => [ "message" ]
#    remove_field => [ "@version", "port" ]
    add_tag => ["unclassified"]
  }

  # Match content of messages

  # Deployment related events.
  grok {
    match => {
        "message" => "Computed new deployment plan for (?<app_id>.*):"
    }
    add_tag => [ "deployment" ]
  }

  grok {
    match => {
        "message" => "Received new deployment plan %{UUID:plan_id} for (?<app_id>.*), no conflicts detected"
    }
    add_tag => [ "deployment" ]
  }

  grok {
    match => {
        "message" => "Stored new deployment plan %{UUID:plan_id} for (?<app_id>.*)"
    }
    add_tag => [ "deployment" ]
  }

  grok {
    match => {
        "message" => "Launching DeploymentActor for %{UUID:plan_id} for (?<app_id>.*)"
    }
    add_tag => [ "deployment" ]
  }

  grok {
    match => {
        "message" => "Deployment %{UUID:plan_id}:.* for (?<app_id>.*) acknowledged"
    }
    add_tag => [ "deployment" ]
  }

  grok {
    match => {
        "message" => "Starting runSpec (?<app_id>.*)"
    }
    add_tag => [ "deployment" ]
  }

  grok {
    match => {
        "message" => "Started instanceLaunchActor for (?<app_id>.*)"
    }
    add_tag => [ "deployment" ]
  }

  grok {
    match => {
        "message" => "No tasks left to launch. Stop receiving offers for (?<app_id>.*)"
    }
    add_tag => [ "deployment" ]
  }

  grok {
    match => {
        "message" => "Deployment %{UUID:plan_id}:.* of (?<app_id>.*) finished"
    }
    add_tag => [ "deployment" ]
  }

  grok {
    match => {
        "message" => "Deployment %{UUID:plan_id}.* of .* finished"
    }
    add_tag => [ "deployment" ]
  }

  # Append date.
  date {
    match => [ "logdate", "ISO8601" ]
    timezone => "UTC"
    remove_field => [ "logdate" ]
  }
}

input {
  file {
    path => '/usr/share/logstash/bundle'
    start_position => 'beginning'
    type => 'log'
    codec => multiline {
        pattern => "^.*\[%{TIMESTAMP_ISO8601}\]"
        negate => true
        what => previous
    }
  }
}

output {
  stdout { codec => rubydebug }
  elasticsearch {
      hosts    => [ 'elasticsearch' ]
      user     => 'elastic'
      password => 'changeme'
  }
}
